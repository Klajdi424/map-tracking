<!DOCTYPE html>
<html>
<head>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDESOPDnAmfX5e5qqWc0Smy6kpj3kfN_J0" async defer></script>
  <script>
    let driverMarker;
    let directionsService;
    let directionsRenderer;
    let map;

    function initMap() {
      const params = new URLSearchParams(window.location.search);
      const driver = (params.has('driverLat') && params.has('driverLng')) ?
        { lat: parseFloat(params.get('driverLat')), lng: parseFloat(params.get('driverLng')) } : null;
      const pickup = (params.has('pickupLat') && params.has('pickupLng')) ?
        { lat: parseFloat(params.get('pickupLat')), lng: parseFloat(params.get('pickupLng')) } : null;
      const dropoff = (params.has('dropoffLat') && params.has('dropoffLng')) ?
        { lat: parseFloat(params.get('dropoffLat')), lng: parseFloat(params.get('dropoffLng')) } : null;
      
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 15,
        center: pickup || driver || dropoff,
        disableDefaultUI: true
      });

      const bounds = new google.maps.LatLngBounds();

      if (pickup) {
        new google.maps.Marker({
          position: pickup,
          map: map,
          icon: {
            url: "https://raw.githubusercontent.com/Klajdi424/image/main/pickup2.png",
            scaledSize: new google.maps.Size(60, 60)
          }
        });
        bounds.extend(pickup);
      }
      
      if (dropoff) {
        new google.maps.Marker({
          position: dropoff,
          map: map,
          icon: {
            url: "https://raw.githubusercontent.com/Klajdi424/image/main/nobackround.png",
            scaledSize: new google.maps.Size(60, 60)
          }
        });
        bounds.extend(dropoff);
      }
      
      if (driver) {
        driverMarker = new google.maps.Marker({
          position: driver,
          map: map,
          icon: {
            url: "https://raw.githubusercontent.com/Klajdi424/image/main/driver.png",
            scaledSize: new google.maps.Size(60, 60)
          }
        });
        bounds.extend(driver);
      }
      
      map.fitBounds(bounds);

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        suppressMarkers: true,
        polylineOptions: { strokeColor: (driver ? "blue" : "red"), strokeWeight: 4 }
      });
      
      if (driver && dropoff && pickup) {
        calculateRoute(driver, dropoff, [{ location: pickup, stopover: true }]);
        setInterval(updateDriverLocation, 2000);
      } else if (driver && dropoff && !pickup) {
        calculateRoute(driver, dropoff, null);
        setInterval(updateDriverLocation, 2000);
      } else if (pickup && dropoff) {
        calculateRoute(pickup, dropoff, null);
      }
    }

    function calculateRoute(origin, destination, waypoints) {
      let request = {
        origin: origin,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING
      };
      if (waypoints) {
        request.waypoints = waypoints;
      }
      directionsService.route(request, (response, status) => {
        if (status === "OK") {
          directionsRenderer.setDirections(response);
        }
      });
    }

    function updateDriverLocation() {
      const params = new URLSearchParams(window.location.search);
      const newDriver = { lat: parseFloat(params.get("driverLat")), lng: parseFloat(params.get("driverLng")) };
      if (driverMarker) {
        driverMarker.setPosition(newDriver);
      }
      const pickup = (params.has("pickupLat") && params.has("pickupLng")) ?
        { lat: parseFloat(params.get("pickupLat")), lng: parseFloat(params.get("pickupLng")) } : null;
      const dropoff = (params.has("dropoffLat") && params.has("dropoffLng")) ?
        { lat: parseFloat(params.get("dropoffLat")), lng: parseFloat(params.get("dropoffLng")) } : null;
      
      if (pickup && dropoff) {
        if (driverMarker.getPosition()) {
          calculateRoute(newDriver, dropoff, [{ location: pickup, stopover: true }]);
        }
      } else if (dropoff) {
        calculateRoute(newDriver, dropoff, null);
      }
      
      const bounds = new google.maps.LatLngBounds();
      if (pickup) bounds.extend(pickup);
      if (dropoff) bounds.extend(dropoff);
      bounds.extend(newDriver);
      map.fitBounds(bounds);
    }
  </script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
  </style>
</head>
<body onload="initMap()">
  <div id="map"></div>
</body>
</html>
