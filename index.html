<!DOCTYPE html>
<html>
<head>
  <title>Map Tracking with Leaflet</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    #loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      text-align: center;
      z-index: 1000;
    }
    #loading p {
      margin-top: 40%;
      font-size: 20px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="loading">
    <p>Loading...</p>
  </div>
  <div id="map"></div>
  <script>
    const osrmBaseURL = "https://router.project-osrm.org/route/v1";

    let map;

    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function addMarker(coords, iconUrl) {
      const icon = L.icon({
        iconUrl: iconUrl,
        iconSize: [40, 40], // size of the icon
        iconAnchor: [20, 40], // point of the icon which will correspond to marker's location
      });
      L.marker(coords, { icon }).addTo(map);
    }

    function drawRoute(start, end, color = "purple") {
      showLoading();

      // OSRM Routing API
      const url = `${osrmBaseURL}/driving/${start.join(',')};${end.join(',')}`;
      console.log("OSRM API URL:", url); // Debugging: Log the API URL

      fetch(`${url}?geometries=geojson`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`OSRM API error: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("OSRM API Response:", data); // Debugging: Log the full response

          if (data.routes && data.routes.length > 0) {
            const route = data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]); // Convert [lng, lat] to [lat, lng]

            console.log("Route Coordinates:", route); // Debugging: Log the route coordinates
            console.log("Route Color:", color); // Debugging: Confirm the color being used

            // Add the polyline to the map
            const polyline = L.polyline(route, { color: color, weight: 6 }).addTo(map);
            console.log("Polyline Added:", polyline); // Debugging: Confirm the polyline is added

            // Fit the map bounds to the route
            const bounds = L.latLngBounds(route);
            map.fitBounds(bounds, { padding: [50, 50] });
          } else {
            console.error('No routes found in OSRM response!');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error fetching route:', error);
          hideLoading();
        });
    }

    function initMap() {
      showLoading();

      const params = new URLSearchParams(window.location.search);

      // Extract parameters from URL
      const driverLat = params.get("driverLat");
      const driverLng = params.get("driverLng");
      const pickupLat = params.get("pickupLat");
      const pickupLng = params.get("pickupLng");
      const dropoffLat = params.get("dropoffLat");
      const dropoffLng = params.get("dropoffLng");

      // Log parameters for debugging
      console.log("Driver Location:", { driverLat, driverLng });
      console.log("Pickup Location:", { pickupLat, pickupLng });
      console.log("Dropoff Location:", { dropoffLat, dropoffLng });

      // Ensure valid coordinates are parsed
      const driver = driverLat && driverLng ? [ parseFloat(driverLat), parseFloat(driverLng) ] : null;
      const pickup = pickupLat && pickupLng ? [ parseFloat(pickupLat), parseFloat(pickupLng) ] : null;
      const dropoff = dropoffLat && dropoffLng ? [ parseFloat(dropoffLat), parseFloat(dropoffLng) ] : null;

      // Initialize Leaflet map
      map = L.map('map').setView([0, 0], 2); // Temporary center and zoom level

      // Add OSM tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      const points = [driver, pickup, dropoff].filter(Boolean);

      if (points.length > 0) {
        const bounds = L.latLngBounds(points);
        map.fitBounds(bounds, { padding: [50, 50] }); // Fit map to markers
      }

      if (pickup) {
        addMarker(pickup, "https://raw.githubusercontent.com/Klajdi424/image/main/pickup2.png");
      }
      if (dropoff) {
        addMarker(dropoff, "https://raw.githubusercontent.com/Klajdi424/image/main/nobackround.png");
      }
      if (driver) {
        addMarker(driver, "https://raw.githubusercontent.com/Klajdi424/image/main/driver.png");
      }

      if (driver && pickup && !dropoff) {
        drawRoute(driver, pickup);
      } else if (driver && dropoff && !pickup) {
        drawRoute(driver, dropoff);
      } else if (pickup && dropoff && !driver) {
        drawRoute(pickup, dropoff);
      }

      hideLoading();
    }

    document.addEventListener("DOMContentLoaded", initMap);
  </script>
</body>
</html>
