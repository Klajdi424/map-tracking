<!DOCTYPE html>
<html>
<head>
  <title>Map Tracking with MapLibre</title>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    #loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      text-align: center;
      z-index: 1000;
    }
    #loading p {
      margin-top: 40%;
      font-size: 20px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="loading">
    <p>Loading...</p>
  </div>
  <div id="map"></div>
  <script>
    const mapTilerKey = "wuowj3548V0ifhTTUk18"; // Replace with your MapTiler API key
    const osrmBaseURL = "https://router.project-osrm.org/route/v1";

    let map;

    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function addMarker(coords, iconUrl) {
      const el = document.createElement('div');
      el.style.backgroundImage = `url(${iconUrl})`;
      el.style.width = '40px';
      el.style.height = '40px';
      el.style.backgroundSize = 'contain';
      el.style.backgroundRepeat = 'no-repeat';

      new maplibregl.Marker(el)
        .setLngLat(coords)
        .addTo(map);
    }

    function drawRoute(start, end, color) {
      showLoading();

      // OSRM Routing API
      const url = `${osrmBaseURL}/driving/${start.join(',')};${end.join(',')}`;
      console.log("OSRM API URL:", url); // Debugging: Log the API URL

      fetch(`${url}?geometries=geojson`)
        .then(response => response.json())
        .then(data => {
          console.log("OSRM API Response:", data); // Debugging: Log the full response

          if (data.routes && data.routes.length > 0) {
            const route = data.routes[0].geometry.coordinates;

            // Add route to the map
            const sourceId = `route-${Date.now()}`;
            map.addSource(sourceId, {
              type: 'geojson',
              data: {
                type: 'Feature',
                geometry: {
                  type: 'LineString',
                  coordinates: route
                }
              }
            });

            map.addLayer({
              id: sourceId,
              type: 'line',
              source: sourceId,
              paint: {
                'line-color': color,
                'line-width': 6
              }
            });
          } else {
            console.error('No routes found in OSRM response!');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error fetching route:', error);
          hideLoading();
        });
    }

    function calculateBounds(points) {
      const bounds = new maplibregl.LngLatBounds();

      points.forEach(point => {
        if (point) {
          bounds.extend(point); // Extend bounds to include the point
        }
      });

      return bounds;
    }

    function initMap() {
      showLoading();

      const params = new URLSearchParams(window.location.search);

      // Extract parameters from URL
      const driverLat = params.get("driverLat");
      const driverLng = params.get("driverLng");
      const pickupLat = params.get("pickupLat");
      const pickupLng = params.get("pickupLng");
      const dropoffLat = params.get("dropoffLat");
      const dropoffLng = params.get("dropoffLng");

      // Log parameters for debugging
      console.log("Driver Location:", { driverLat, driverLng });
      console.log("Pickup Location:", { pickupLat, pickupLng });
      console.log("Dropoff Location:", { dropoffLat, dropoffLng });

      // Ensure valid coordinates are parsed
      const driver = driverLat && driverLng ? [ parseFloat(driverLng), parseFloat(driverLat) ] : null;
      const pickup = pickupLat && pickupLng ? [ parseFloat(pickupLng), parseFloat(pickupLat) ] : null;
      const dropoff = dropoffLat && dropoffLng ? [ parseFloat(dropoffLng), parseFloat(dropoffLat) ] : null;

      // Initialize MapLibre map
      map = new maplibregl.Map({
        container: 'map',
        style: `https://api.maptiler.com/maps/basic/style.json?key=${mapTilerKey}`,
        center: [0, 0], // Temporary center, will be adjusted to bounds
        zoom: 2, // Temporary zoom, will be adjusted to bounds
        interactive: true
      });

      map.on('load', () => {
        const points = [driver, pickup, dropoff];
        const bounds = calculateBounds(points);

        // Adjust map to fit all points
        if (!bounds.isEmpty()) {
          map.fitBounds(bounds, { padding: 50, animate: false }); // Fit bounds without animation
        }

        if (pickup) {
          addMarker(pickup, "https://raw.githubusercontent.com/Klajdi424/image/main/pickup2.png");
        }
        if (dropoff) {
          addMarker(dropoff, "https://raw.githubusercontent.com/Klajdi424/image/main/nobackround.png");
        }
        if (driver) {
          addMarker(driver, "https://raw.githubusercontent.com/Klajdi424/image/main/driver.png");
        }

        if (driver && pickup && !dropoff) {
          drawRoute(driver, pickup, "purple");
        } else if (driver && dropoff && !pickup) {
          drawRoute(driver, dropoff, "purple");
        } else if (pickup && dropoff && !driver) {
          drawRoute(pickup, dropoff, "purple");
        }

        hideLoading();
      });
    }

    document.addEventListener("DOMContentLoaded", initMap);
  </script>
</body>
</html>
