<!DOCTYPE html>
<html>
<head>
  <title>Map Tracking with Leaflet</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    #loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      text-align: center;
      z-index: 1000;
    }
    #loading p {
      margin-top: 40%;
      font-size: 20px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="loading">
    <p>Loading...</p>
  </div>
  <div id="map"></div>
  <script>
    const osrmBaseURL = "https://router.project-osrm.org/route/v1";

    let map;

    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function addMarker(coords, iconUrl) {
      const icon = L.icon({
        iconUrl: iconUrl,
        iconSize: [40, 40],
        iconAnchor: [20, 40],
      });
      L.marker(coords, { icon }).addTo(map);
    }

    function drawRoute(start, end, color = "purple") {
      showLoading();

      const url = `${osrmBaseURL}/driving/${start.join(',')};${end.join(',')}?geometries=geojson`;

      console.log("OSRM API URL:", url);

      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error(`OSRM API error: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("OSRM API Response:", data);

          if (data.routes && data.routes.length > 0) {
            const rawCoordinates = data.routes[0].geometry.coordinates;
            console.log("Raw Route Coordinates:", rawCoordinates);

            const route = rawCoordinates.map(coord => L.latLng(coord[1], coord[0]));
            console.log("Converted Route Coordinates:", route);

            const polyline = L.polyline(route, { color: color, weight: 6 }).addTo(map);
            console.log("Polyline Added:", polyline);

            const bounds = L.latLngBounds(route);
            map.fitBounds(bounds, { padding: [20, 20] }); // Reduce padding for a closer zoom
          } else {
            console.error('No routes found in OSRM response!');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error fetching route:', error);
          hideLoading();
        });
    }

    function initMap() {
      showLoading();

      const params = new URLSearchParams(window.location.search);

      const driverLat = params.get("driverLat");
      const driverLng = params.get("driverLng");
      const pickupLat = params.get("pickupLat");
      const pickupLng = params.get("pickupLng");
      const dropoffLat = params.get("dropoffLat");
      const dropoffLng = params.get("dropoffLng");

      console.log("Driver Location:", { driverLat, driverLng });
      console.log("Pickup Location:", { pickupLat, pickupLng });
      console.log("Dropoff Location:", { dropoffLat, dropoffLng });

      const driver = driverLat && driverLng ? [parseFloat(driverLat), parseFloat(driverLng)] : null;
      const pickup = pickupLat && pickupLng ? [parseFloat(pickupLat), parseFloat(pickupLng)] : null;
      const dropoff = dropoffLat && dropoffLng ? [parseFloat(dropoffLat), parseFloat(dropoffLng)] : null;

      map = L.map('map', { zoomAnimation: false }).setView([0, 0], 2);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      const points = [driver, pickup, dropoff].filter(Boolean);

      if (points.length > 0) {
        const bounds = L.latLngBounds(points);
        map.fitBounds(bounds, { padding: [20, 20] });
        map.setZoom(map.getZoom() - 1); // Adjust zoom level to be closer
      }

      if (pickup) {
        addMarker(pickup, "https://raw.githubusercontent.com/Klajdi424/image/main/pickup2.png");
      }
      if (dropoff) {
        addMarker(dropoff, "https://raw.githubusercontent.com/Klajdi424/image/main/nobackround.png");
      }
      if (driver) {
        addMarker(driver, "https://raw.githubusercontent.com/Klajdi424/image/main/driver.png");
      }

      if (driver && pickup && !dropoff) {
        drawRoute(driver, pickup);
      } else if (driver && dropoff && !pickup) {
        drawRoute(driver, dropoff);
      } else if (pickup && dropoff && !driver) {
        drawRoute(pickup, dropoff);
      }

      hideLoading();
    }

    document.addEventListener("DOMContentLoaded", initMap);
  </script>
</body>
</html>
