<!DOCTYPE html>
<html>
<head>
  <title>Map Tracking with HERE Maps</title>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
  <link rel="stylesheet" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    #loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      text-align: center;
      z-index: 1000;
    }
    #loading p {
      margin-top: 40%;
      font-size: 20px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="loading">
    <p>Loading...</p>
  </div>
  <div id="map"></div>
  <script>
    const apiKey = "vO-RUqi5fLyGtSjW5V89LgbBEBpE9FAmHkuHnqaiTrM"; // Replace with your HERE Maps API key

    let map;
    let driverMarker;
    let pickupMarker;
    let dropoffMarker;
    let platform;
    let router;

    const defaultCenter = { lat: 40.748817, lng: -73.985428 }; // New York City
    const defaultZoom = 13;

    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function addMarker(coords, iconUrl) {
      const icon = new H.map.Icon(iconUrl, { size: { w: 40, h: 40 } });
      const marker = new H.map.Marker(coords, { icon: icon });
      map.addObject(marker);
      return marker;
    }

    // Decode the polyline from HERE API response
    function decodePolyline(encodedPolyline) {
      const coords = [];
      const factor = Math.pow(10, 5);
      let index = 0,
        lat = 0,
        lng = 0;

      while (index < encodedPolyline.length) {
        let b, shift = 0, result = 0;
        do {
          b = encodedPolyline.charCodeAt(index++) - 63;
          result |= (b & 0x1f) << shift;
          shift += 5;
        } while (b >= 0x20);
        const deltaLat = ((result & 1) ? ~(result >> 1) : (result >> 1));
        lat += deltaLat;

        shift = 0;
        result = 0;
        do {
          b = encodedPolyline.charCodeAt(index++) - 63;
          result |= (b & 0x1f) << shift;
          shift += 5;
        } while (b >= 0x20);
        const deltaLng = ((result & 1) ? ~(result >> 1) : (result >> 1));
        lng += deltaLng;

        coords.push({ lat: lat / factor, lng: lng / factor });
      }

      return coords;
    }

    function drawRoute(start, end, color) {
      showLoading();
      const routingParameters = {
        transportMode: "car", // Valid transport mode
        origin: `${start.lat},${start.lng}`, // Start point
        destination: `${end.lat},${end.lng}`, // End point
        return: "polyline" // Required to get route geometry
      };

      router.calculateRoute(routingParameters, (result) => {
        if (result.routes && result.routes.length > 0) {
          const route = result.routes[0];
          const polyline = route.sections[0].polyline; // Get polyline from section
          const decodedPolyline = decodePolyline(polyline); // Decode polyline

          const lineString = new H.geo.LineString();
          decodedPolyline.forEach((point) => {
            lineString.pushLatLngAlt(point.lat, point.lng); // Add points to LineString
          });

          // Render the polyline on the map
          const routeLine = new H.map.Polyline(lineString, {
            style: { strokeColor: color, lineWidth: 6 }
          });

          map.addObject(routeLine);
          map.getViewModel().setLookAtData({ bounds: routeLine.getBoundingBox() }); // Adjust zoom to fit route
        } else {
          console.error("No routes found in HERE API response!");
        }
        hideLoading();
      }, (error) => {
        console.error("Error calculating route:", error);
        hideLoading();
      });
    }

    function initMap() {
      showLoading();

      const params = new URLSearchParams(window.location.search);

      const driver = params.has("driverLat") && params.has("driverLng") 
        ? { lat: parseFloat(params.get("driverLat")), lng: parseFloat(params.get("driverLng")) } 
        : null;
      const pickup = params.has("pickupLat") && params.has("pickupLng") 
        ? { lat: parseFloat(params.get("pickupLat")), lng: parseFloat(params.get("pickupLng")) } 
        : null;
      const dropoff = params.has("dropoffLat") && params.has("dropoffLng") 
        ? { lat: parseFloat(params.get("dropoffLat")), lng: parseFloat(params.get("dropoffLng")) } 
        : null;

      platform = new H.service.Platform({ apikey: apiKey });
      const defaultLayers = platform.createDefaultLayers();

      map = new H.Map(document.getElementById("map"), defaultLayers.vector.normal.map, {
        center: defaultCenter,
        zoom: defaultZoom,
        pixelRatio: window.devicePixelRatio || 1
      });

      window.addEventListener("resize", () => map.getViewPort().resize());

      const behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
      const ui = H.ui.UI.createDefault(map, defaultLayers);

      router = platform.getRoutingService();

      if (pickup) {
        pickupMarker = addMarker(pickup, "https://raw.githubusercontent.com/Klajdi424/image/main/pickup2.png");
      }
      if (dropoff) {
        dropoffMarker = addMarker(dropoff, "https://raw.githubusercontent.com/Klajdi424/image/main/nobackround.png");
      }
      if (driver) {
        driverMarker = addMarker(driver, "https://raw.githubusercontent.com/Klajdi424/image/main/driver.png");
      }

      if (driver && pickup && !dropoff) {
        drawRoute(driver, pickup, "purple");
      } else if (driver && dropoff && !pickup) {
        drawRoute(driver, dropoff, "purple");
      } else if (pickup && dropoff && !driver) {
        drawRoute(pickup, dropoff, "purple");
      }

      hideLoading();
    }

    document.addEventListener("DOMContentLoaded", initMap);
  </script>
</body>
</html>
