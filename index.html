<!DOCTYPE html>
<html>
<head>
  <title>Map Tracking with MapLibre</title>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    #loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      text-align: center;
      z-index: 1000;
    }
    #loading p {
      margin-top: 40%;
      font-size: 20px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="loading">
    <p>Loading...</p>
  </div>
  <div id="map"></div>
  <script>
    // Constants
    const mapTilerKey = "wuowj3548V0ifhTTUk18"; // Replace with your MapTiler API key
    const osrmBaseURL = "https://router.project-osrm.org/route/v1";

    let map;
    let driverMarker;
    let pickupMarker;
    let dropoffMarker;

    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function addMarker(coords, iconUrl) {
      const el = document.createElement('div');
      el.style.backgroundImage = `url(${iconUrl})`;
      el.style.width = '40px';
      el.style.height = '40px';
      el.style.backgroundSize = 'contain';
      el.style.backgroundRepeat = 'no-repeat';

      new maplibregl.Marker(el)
        .setLngLat(coords)
        .addTo(map);
    }

    function drawRoute(start, end, color) {
      showLoading();

      // OSRM Routing API
      const url = `${osrmBaseURL}/driving/${start.join(',')};${end.join(',')}`;
      fetch(`${url}?geometries=geojson`)
        .then(response => response.json())
        .then(data => {
          if (data.routes && data.routes.length > 0) {
            const route = data.routes[0].geometry.coordinates;

            map.addLayer({
              id: `route-${Date.now()}`,
              type: 'line',
              source: {
                type: 'geojson',
                data: {
                  type: 'Feature',
                  geometry: {
                    type: 'LineString',
                    coordinates: route
                  }
                }
              },
              paint: {
                'line-color': color,
                'line-width': 6
              }
            });
          } else {
            console.error('No routes found in OSRM response!');
          }
          hideLoading();
        })
        .catch(error => {
          console.error('Error fetching route:', error);
          hideLoading();
        });
    }

    function calculateBounds(points) {
      const bounds = new maplibregl.LngLatBounds();

      points.forEach(point => {
        if (point) {
          bounds.extend(point); // Extend bounds to include the point
        }
      });

      return bounds;
    }

    function initMap() {
      showLoading();

      const params = new URLSearchParams(window.location.search);

      const driver = params.has("driverLat") && params.has("driverLng") 
        ? [ parseFloat(params.get("driverLng")), parseFloat(params.get("driverLat")) ] // [lng, lat]
        : null;
      const pickup = params.has("pickupLat") && params.has("pickupLng") 
        ? [ parseFloat(params.get("pickupLng")), parseFloat(params.get("pickupLat")) ] // [lng, lat]
        : null;
      const dropoff = params.has("dropoffLat") && params.has("dropoffLng") 
        ? [ parseFloat(params.get("dropoffLng")), parseFloat(params.get("dropoffLat")) ] // [lng, lat]
        : null;

      // Initialize MapLibre map
      map = new maplibregl.Map({
        container: 'map',
        style: `https://api.maptiler.com/maps/basic/style.json?key=${mapTilerKey}`,
        center: [0, 0], // Temporary center, will be adjusted to bounds
        zoom: 2 // Temporary zoom, will be adjusted to bounds
      });

      map.on('load', () => {
        const points = [driver, pickup, dropoff];
        const bounds = calculateBounds(points);

        // Adjust map to fit all points
        if (!bounds.isEmpty()) {
          map.fitBounds(bounds, { padding: 50 }); // Fit bounds with padding
        }

        if (pickup) {
          addMarker(pickup, "https://raw.githubusercontent.com/Klajdi424/image/main/pickup2.png");
        }
        if (dropoff) {
          addMarker(dropoff, "https://raw.githubusercontent.com/Klajdi424/image/main/nobackround.png");
        }
        if (driver) {
          addMarker(driver, "https://raw.githubusercontent.com/Klajdi424/image/main/driver.png");
        }

        if (driver && pickup && !dropoff) {
          drawRoute(driver, pickup, "purple");
        } else if (driver && dropoff && !pickup) {
          drawRoute(driver, dropoff, "purple");
        } else if (pickup && dropoff && !driver) {
          drawRoute(pickup, dropoff, "purple");
        }

        hideLoading();
      });
    }

    document.addEventListener("DOMContentLoaded", initMap);
  </script>
</body>
</html>
